@using PROG7311_POE_ST10150702.ViewModels
@model EmployeeDashboardViewModel
@{
    ViewData["Title"] = "Employee Dashboard";
    Layout = "_Layout";
}

<div class="container-fluid mt-4 wide-container">
    <!-- Notification Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <h1>Employee Dashboard</h1>
    <p class="mb-4">Welcome, @User.Identity.Name!</p>

    <!-- Farmer Filter Dropdown -->
    <div class="form-group mb-4">
        <label for="farmerFilter">Filter by Farmer:</label>
        <select class="form-control" id="farmerFilter">
            <option value="">All Farmers</option>
            @foreach (var farmer in Model.Farmers)
            {
                <option value="@farmer.FarmerId">@farmer.FirstName @farmer.LastName (@farmer.Region)</option>
            }
        </select>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column: Farmers Table and Add Farmer Button -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow farmer-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Farmers</h3>
                    <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#addFarmerModal">
                        <i class="fas fa-plus"></i> Add New Farmer
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="height: 500px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0 wide-table" id="farmersTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Region</th>
                                    <th>Email</th>
                                    <th>POPPIA</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var farmer in Model.Farmers)
                                {
                                    <tr>
                                        <td>@farmer.FarmerId</td>
                                        <td>@farmer.FirstName</td>
                                        <td>@farmer.LastName</td>
                                        <td>@farmer.Region</td>
                                        <td>@farmer.User?.Email</td>
                                        <td>@(farmer.AcceptedPOPPIA ? "Yes" : "No")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Products Table -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow product-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Products</h3>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="height: 500px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0 wide-table" id="productsTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                    <th>Farmer</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model.Products)
                                {
                                    <tr class="product-row" data-farmer-id="@product.FarmerId">
                                        <td>@product.ProductId</td>
                                        <td>@product.Name</td>
                                        <td>@product.Category</td>
                                        <td>@product.ProductionDate.ToString("d")</td>
                                        <td>
                                            @{
                                                var farmer = Model.Farmers.FirstOrDefault(f => f.FarmerId == product.FarmerId);
                                                @($"{farmer?.FirstName} {farmer?.LastName}")
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Farmer Modal -->
<div class="modal fade" id="addFarmerModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Farmer</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form asp-action="AddFarmer" method="post" id="addFarmerForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label>First Name</label>
                        <input name="FirstName" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input name="LastName" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input name="Email" type="email" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input name="Password" type="password" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <select name="Region" class="form-control" required>
                            <option value="">Select Region</option>
                            <option value="North America">North America</option>
                            <option value="South America">South America</option>
                            <option value="Europe">Europe</option>
                            <option value="Africa">Africa</option>
                            <option value="Asia">Asia</option>
                            <option value="Australasia">Australasia</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="AcceptedPOPPIA" value="true" class="form-check-input" id="popiaCheck" />
                        <input type="hidden" name="AcceptedPOPPIA" value="false" />
                        <label class="form-check-label" for="popiaCheck">Accept POPPIA</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Farmer</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <style>

        .cards-wrapper {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .farmer-card, .product-card {
            flex-grow: 1;
            background-color: #fff;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 8px;
            overflow: visible;
        }


    .table-responsive {
        padding: 10px; /* Space around the table inside the card */
        height: 500px;
        overflow-y: auto;
    }

    .table th {
        white-space: nowrap;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #343a40;
        z-index: 1;
        color: #fff;
    }

    .wide-table th, .wide-table td {
        padding: 14px 18px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Optional: Add soft shadow for better visuals */
    .card {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

        .table th, .table td {
            width: auto;
            white-space: nowrap;
        }

        /* Table fills card */
        .wide-table {
            width: 100%;
            table-layout: auto;
        }

    /* Responsive layout adjustments */
    @@media (min-width: 1400px) {
        .col-xl-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }

    </style>
}

@section Scripts {
    <script>
        $(function () {
            // Farmer filter functionality - FIXED
            $('#farmerFilter').change(function () {
                var farmerId = $(this).val();
                if (farmerId) {
                    // Hide all rows first
                    $('#productsTable tbody tr').hide();
                    // Show only rows with matching farmer ID using data attributes
                    $('#productsTable tbody tr[data-farmer-id="' + farmerId + '"]').show();
                } else {
                    // Show all rows when "All Farmers" is selected
                    $('#productsTable tbody tr').show();
                }
            });

            // Form validation
            $('#addFarmerForm').validate({
                rules: {
                    FirstName: "required",
                    LastName: "required",
                    Email: {
                        required: true,
                        email: true
                    },
                    Password: {
                        required: true,
                        minlength: 6
                    },
                    Region: "required"
                },
                messages: {
                    FirstName: "Please enter first name",
                    LastName: "Please enter last name",
                    Email: {
                        required: "Please enter email address",
                        email: "Please enter a valid email address"
                    },
                    Password: {
                        required: "Please provide a password",
                        minlength: "Password must be at least 6 characters long"
                    },
                    Region: "Please select a region"
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                },
                submitHandler: function (form) {
                    $('#addFarmerModal').modal('hide');
                    form.submit();
                }
            });
        });
    </script>
}